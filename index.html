<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<title>연구실 배정 v1.28 (Room Dropzones)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{ --primary:#409eff; --line:#ddd; --muted:#666; }
*{ box-sizing:border-box }
body{ font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; margin:16px; color:#222; }

.toolbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px; flex-wrap:wrap; }
.group{ display:flex; gap:8px; align-items:center; }
.btn{ border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; }
.hint{ font-size:12px; color:#666; }
.version{ font-size:12px; background:#f2f6ff; border:1px solid #cfe0ff; color:#2b5db7; padding:4px 8px; border-radius:8px; }

.statusbar{ border:1px dashed #e5e7eb; background:#fafafa; padding:6px 10px; border-radius:8px; margin-bottom:8px; font-size:12px; color:#555; }

.layout{ display:grid; grid-template-columns: 1fr 420px; gap:16px; }
.canvasWrap{ border:1px solid var(--line); border-radius:10px; padding:10px; min-height:560px; position:relative; }

.svgHost{ position:relative; min-height:520px; overflow:auto; background:#fff; }
#svgLayer{ position:relative; z-index:0; }
#svgLayer svg{ width:100%; height:auto; display:block; }
#overlay{ position:absolute; left:0; top:0; width:100%; height:100%; z-index:10; pointer-events:none; }
.placeholder{ color:#999; display:flex; align-items:center; justify-content:center; height:480px; border:2px dashed #ccc; border-radius:12px; }

/* 배경 그룹은 드롭 금지 */
[id^="bg"], [id^="BG"]{ pointer-events:none; }

/* ‘방 드롭존’ (투명 사각형) */
.dropzone{
  position:absolute; border:2px dashed transparent; pointer-events:auto; z-index:11;
}
.dropzone.hover{ border-color:var(--primary); }

/* 방 라벨 */
.roomLabel{
  position:absolute; font-size:11px; font-weight:700; color:#fff; padding:2px 6px;
  border-radius:999px; transform:translate(-50%,-100%); pointer-events:none; white-space:nowrap;
  border:1px solid rgba(0,0,0,.1); z-index:12;
}
.roomLabel.violet{ background:#7c3aed; } /* 1인실 */
.roomLabel.blue{   background:#3b82f6; } /* 남 */
.roomLabel.red{    background:#ef4444; } /* 여 */
.roomLabel.gray{   background:#6b7280; } /* 기타 */

/* 점유 칩(방 안 카드) */
.occChip{
  position:absolute; font-size:11px; line-height:1.15;
  padding:4px 6px; border-radius:8px; background:#fafafa; border:1px solid #ccc;
  cursor:grab; white-space:pre-line; min-width:56px; text-align:center;
  pointer-events:auto; z-index:13;
}
.occChip.male{ border-color:#7aa; background:#eef6ff; }
.occChip.female{ border-color:#a77; background:#ffeef0; }

/* 오른쪽 패널 */
.side{ border:1px solid var(--line); border-radius:10px; padding:12px; min-height:560px; display:flex; flex-direction:column; gap:8px; }
.controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
#deptFilter, #genderFilter, #search{ padding:8px 10px; border:1px solid var(--line); border-radius:8px; }
#deptFilter{ min-width:160px; } #genderFilter{ min-width:120px; } #search{ width:200px; }
.people{ min-height:200px; border:2px dashed #e6e6e6; border-radius:10px; padding:8px; }
.people.scrollable{ max-height:60vh; overflow:auto; }
.people.drop-hover{ outline:2px solid var(--primary); }
.people .card{ border:1px solid #eee; border-radius:10px; padding:8px; margin-bottom:8px; background:#fafafa; cursor:grab; }
.card.male{ border-color:#8bb; background:#eef6ff; }
.card.female{ border-color:#b88; background:#ffeef0; }
.card .meta{ font-size:12px; color:#555; margin-top:2px; }
.badge{ display:inline-block; padding:2px 6px; border-radius:10px; background:#eef; margin-left:6px; font-size:12px; }
.badge.room{ background:#e8f5e9; border:1px solid #c8e6c9; }

/* 방 설정 패널 */
.panel{ position:fixed; right:16px; top:96px; width:340px; border:1px solid var(--line); background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:12px; display:none; }
.panel.show{ display:block; }
.panel h4{ margin:0 0 8px; }
.row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
.row label{ width:84px; font-size:13px; color:#444; }
.row input, .row select{ flex:1; padding:8px 10px; border:1px solid var(--line); border-radius:8px; }
.panel .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
</style>
</head>
<body>
  <header class="toolbar">
    <div class="group">
      <label class="btn">SVG 업로드<input type="file" id="svgInput" accept=".svg" hidden/></label>
      <label class="btn">약어 업로드<input type="file" id="abbrInput" accept=".xlsx,.xlsm,.xls" hidden/></label>
      <label class="btn">교원 엑셀 업로드<input type="file" id="xlInput" accept=".xlsx,.xlsm,.xls" hidden/></label>
      <button id="resetBtn" class="btn">초기화</button>
    </div>
    <div class="group">
      <span class="hint">bg 제외 id 요소가 ‘방’</span>
      <span class="version">v1.28</span>
    </div>
  </header>

  <div class="statusbar"><span id="status">v1.28 | SVG/약어/교원 엑셀을 업로드하세요</span></div>

  <main class="layout">
    <section class="canvasWrap">
      <div id="svgHost" class="svgHost">
        <div class="placeholder">왼쪽의 <b>SVG</b>, <b>약어 엑셀</b>(선택), <b>교원 엑셀</b>을 업로드하세요</div>
        <div id="svgLayer"></div>
        <div id="overlay"></div>
      </div>
    </section>

    <aside class="side">
      <h3>교수 목록</h3>
      <div class="hint">정렬: 직위 → 호봉(내림) → 승급일 → 생년월일</div>
      <div class="controls">
        <select id="deptFilter"><option value="">전체 진료과</option></select>
        <select id="genderFilter">
          <option value="">전체 성별</option>
          <option value="남자">남자</option>
          <option value="여자">여자</option>
        </select>
        <input id="search" type="text" placeholder="교수 이름 검색"/>
      </div>
      <div id="people" class="people scrollable"></div>
      <div class="hint" style="font-size:11px">※ 오른쪽으로 드롭하면 “배정 취소”</div>
    </aside>
  </main>

  <!-- 방 설정 패널 -->
  <div id="roomPanel" class="panel">
    <h4 id="panelTitle">방 설정</h4>
    <div class="row"><label>방 ID</label><input id="p_roomId" disabled></div>
    <div class="row">
      <label>방 타입</label>
      <select id="p_type">
        <option value="">(자유)</option>
        <option>1인실</option><option>2인실</option><option>3인실</option>
        <option>4인실</option><option>6인실</option>
      </select>
    </div>
    <div class="row"><label>정원</label><input id="p_capacity" type="number" min="1" value="1"></div>
    <div class="row">
      <label>성별 제한</label>
      <select id="p_gender">
        <option value="">무관</option>
        <option value="남자">남자</option>
        <option value="여자">여자</option>
      </select>
    </div>
    <div class="actions">
      <button id="clearRoom" class="btn">배정 전부 해제</button>
      <button id="closePanel" class="btn">닫기</button>
      <button id="applyPanel" class="btn" style="background:#409eff;color:#fff;border-color:#409eff">적용</button>
    </div>
  </div>

<script>
(() => {
  const statusEl = document.getElementById('status');
  const setStatus = (m) => statusEl.textContent = 'v1.28 | ' + m;

  const state = {
    people:[], assigned:new Map(), roomState:new Map(),
    svgEl:null, labels:new Map(), dropzones:new Map(), deptAbbr:new Map(),
    search:"", deptFilter:"", genderFilter:""
  };

  const TITLE_ORDER = {"교수":1,"부교수":2,"조교수":3,"임상교수":4,"임상부교수":5,"임상조교수":6,"임상진료조교수":7,"임상강사":8};
  const toInt = s => { const n=parseInt(String(s||"").split(".")[0],10); return isNaN(n)?-999999:n; };
  const sortPeople=(a,b)=>{ const t=(TITLE_ORDER[a.직위]||99)-(TITLE_ORDER[b.직위]||99); if(t) return t; const s=toInt(b.호봉)-toInt(a.호봉); if(s) return s; const p=String(a.승급일||"").localeCompare(String(b.승급일||"")); if(p) return p; return String(a.생년월일||"").localeCompare(String(b.생년월일||"")); };

  const svgHost   = document.getElementById('svgHost');
  const svgLayer  = document.getElementById('svgLayer');
  const overlay   = document.getElementById('overlay');
  const peopleBox = document.getElementById('people');
  const svgInput  = document.getElementById('svgInput');
  const abbrInput = document.getElementById('abbrInput');
  const xlInput   = document.getElementById('xlInput');
  const resetBtn  = document.getElementById('resetBtn');
  const searchInp = document.getElementById('search');
  const deptFilter= document.getElementById('deptFilter');
  const genderFilter= document.getElementById('genderFilter');

  /* ========== 공통 유틸 ========== */
  function ensureRoom(id){ if(!state.roomState.has(id)) state.roomState.set(id,{capacity:1,gender:"",type:"",occupants:[]}); return state.roomState.get(id); }
  const getPerson=(pid)=> state.people.find(x=>x.사번===pid);
  function nodeBBoxInHost(node){ const r=node.getBoundingClientRect(), h=svgHost.getBoundingClientRect(); return { x:r.left-h.left+svgHost.scrollLeft, y:r.top-h.top+svgHost.scrollTop, w:r.width, h:r.height }; }
  function abbrDept(name){ return state.deptAbbr.get(name) || name || ""; }
  function expectedRoom(p){
    if (p.부서==="마취통증의학과" || p.부서==="진단검사의학과") return "과내";
    if (String(p.직계||"").startsWith("진료")) return "불가";
    if (p.직위==="교수") return "1인실";
    if (p.직위==="부교수" || p.직위==="조교수") return "2인실";
    if (String(p.직위||"").startsWith("임상")) return "3~4인실";
    return "3~6인실";
  }
  function labelStyle(st){
    if (st.type==="1인실" || st.capacity===1) return {txt:"1", cls:"violet"};
    const cap = st.capacity || (st.type?parseInt(st.type):"");
    if (st.gender==="여자") return {txt:`여${cap||""}`, cls:"red"};
    if (st.gender==="남자") return {txt:`남${cap||""}`, cls:"blue"};
    if (st.type){ const m = st.type.match(/(\d)/); const n=m?m[1]:""; return {txt:`${n||cap||""}`, cls:"gray"}; }
    return {txt:`${cap||""}`, cls:"gray"};
  }

  /* ========== 방 라벨 & 칩 렌더 ========== */
  function renderRoomLabel(roomId){
    const node=state.svgEl?.querySelector('#'+CSS.escape(roomId)); if(!node) return;
    const st=ensureRoom(roomId); const {txt,cls}=labelStyle(st);
    let el = state.labels.get(roomId);
    if(!el){ el=document.createElement('div'); el.className='roomLabel'; el.dataset.room=roomId; overlay.appendChild(el); state.labels.set(roomId, el); }
    el.textContent = txt || ''; el.className = `roomLabel ${cls}`;
    const box=nodeBBoxInHost(node); el.style.left=`${box.x+box.w/2}px`; el.style.top=`${box.y-4}px`;
  }
  function layoutChips(roomId){
    const st=ensureRoom(roomId), node=state.svgEl?.querySelector('#'+CSS.escape(roomId)); if(!node) return;
    overlay.querySelectorAll(`.occChip[data-room="${CSS.escape(roomId)}"]`).forEach(el=>el.remove());
    const box=nodeBBoxInHost(node), pad=4, cols=Math.max(1,Math.floor(box.w/80));
    st.occupants.forEach((pid,i)=>{
      const p=getPerson(pid); if(!p) return;
      const chip=document.createElement('div');
      chip.className='occChip '+(p.성별==="남자"?"male":"female");
      chip.dataset.room=roomId; chip.dataset.pid=pid; chip.draggable=true;
      chip.textContent=`${abbrDept(p.부서)}\n${p.성명}`;
      const c=i%cols, r=Math.floor(i/cols);
      chip.style.left=`${box.x + pad + c * Math.max(80, (box.w - pad*2)/cols)}px`;
      chip.style.top =`${box.y + pad + r * 26}px`;
      chip.addEventListener('dragstart', e=>{
        e.dataTransfer.effectAllowed='move';
        const ghost=document.createElement('canvas'); ghost.width=1; ghost.height=1; e.dataTransfer.setDragImage(ghost,0,0);
        e.dataTransfer.setData('application/json', JSON.stringify(p));
        e.dataTransfer.setData('text/pid', p.사번);
        e.dataTransfer.setData('text/from','room');
        e.dataTransfer.setData('text/roomId', roomId);
      });
      overlay.appendChild(chip);
    });
  }
  function renderRoom(roomId){ layoutChips(roomId); renderRoomLabel(roomId); }

  /* ========== 드롭존(방별 투명 사각형) 생성/배치 ========== */
  function buildDropzones(){
    // 모두 제거
    overlay.querySelectorAll('.dropzone').forEach(z=>z.remove());
    state.dropzones.clear();

    if(!state.svgEl) return;
    const nodes=[...state.svgEl.querySelectorAll('[id]')].filter(n=>{ const id=(n.id||'').toLowerCase(); return id && !id.startsWith('bg'); });

    nodes.forEach(n=>{
      const id=n.id; ensureRoom(id);
      const box=nodeBBoxInHost(n);
      const dz=document.createElement('div');
      dz.className='dropzone'; dz.style.left=`${box.x}px`; dz.style.top=`${box.y}px`; dz.style.width=`${box.w}px`; dz.style.height=`${box.h}px`;
      dz.dataset.roomId=id;

      dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('hover'); });
      dz.addEventListener('dragleave', ()=> dz.classList.remove('hover'));
      dz.addEventListener('drop', e=>{
        e.preventDefault(); dz.classList.remove('hover');
        const pid=e.dataTransfer.getData('text/pid'); if(!pid) return;
        const json=e.dataTransfer.getData('application/json'); const from=e.dataTransfer.getData('text/from'); const prev=e.dataTransfer.getData('text/roomId')||null;
        const p=json?JSON.parse(json):null; if(!p) return;
        const st=ensureRoom(id);

        // 동일 방이면 무시
        if (state.assigned.get(pid) === id){ setStatus(`${p.성명}: 이미 ${id}`); return; }
        // 제한 체크
        if (st.gender && p.성별 && st.gender!==p.성별){ alert(`성별 제한: ${st.gender}`); return; }
        if (st.capacity && st.occupants.length >= st.capacity){ alert(`정원 초과 (정원:${st.capacity})`); return; }

        // 이전 방에서 제거
        if (from==='room'){
          const os=ensureRoom(prev); os.occupants=os.occupants.filter(x=>x!==pid); renderRoom(prev);
        } else if (state.assigned.has(pid)) {
          const old=state.assigned.get(pid); const os=ensureRoom(old); os.occupants=os.occupants.filter(x=>x!==pid); renderRoom(old);
        }

        // 새 방에 추가
        st.occupants.push(pid);
        state.assigned.set(pid, id);
        renderRoom(id);
        renderPeople();
        setStatus(`배정: ${p.성명} → ${id}`);
      });

      // 클릭하면 방 설정 패널
      dz.addEventListener('click', ()=>{
        const st=ensureRoom(id);
        p_roomId.value=id; p_type.value=st.type||""; p_capacity.value=st.capacity||1; p_gender.value=st.gender||"";
        document.getElementById('panelTitle').textContent=`방 설정 (${id})`;
        panel.classList.add('show');
      });

      overlay.appendChild(dz);
      state.dropzones.set(id,dz);
    });
  }
  function relayoutDropzonesAndLabels(){
    if(!state.svgEl) return;
    state.dropzones.forEach((dz,id)=>{
      const node=state.svgEl.querySelector('#'+CSS.escape(id)); if(!node) return;
      const box=nodeBBoxInHost(node);
      dz.style.left=`${box.x}px`; dz.style.top=`${box.y}px`; dz.style.width=`${box.w}px`; dz.style.height=`${box.h}px`;
    });
    // 라벨/칩도 위치 재계산
    state.roomState.forEach((_, id)=>{ renderRoomLabel(id); layoutChips(id); });
  }

  // 스크롤/리사이즈에 반응
  svgHost.addEventListener('scroll', relayoutDropzonesAndLabels);
  window.addEventListener('resize', relayoutDropzonesAndLabels);

  /* ========== 우측 목록 렌더 & 취소 드롭 ========== */
  function renderPeople(){
    const kw=(state.search||"").trim(); const re=kw?new RegExp(kw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')):null;
    const list=state.people
      .filter(p=>!state.assigned.has(p.사번))
      .filter(p=>!state.deptFilter || p.부서===state.deptFilter)
      .filter(p=>!state.genderFilter || p.성별===state.genderFilter)
      .filter(p=>!re||re.test(p.성명))
      .sort(sortPeople);

    peopleBox.innerHTML="";
    list.forEach(p=>{
      const card=document.createElement('div');
      card.className='card '+(p.성별==="남자"?"male":"female");
      card.draggable=true; card.dataset.pid=p.사번;
      const exp=expectedRoom(p);
      card.innerHTML=`<div><b>${p.성명}</b> <span class="badge">${p.직위}</span> <span class="badge room">${exp}</span></div>
                      <div class="meta">${abbrDept(p.부서)} · ${p.성별} · 승급:${p.승급일} · 생:${p.생년월일} · 호봉:${p.호봉}</div>`;
      card.addEventListener('dragstart', e=>{
        e.dataTransfer.effectAllowed='move';
        const ghost=document.createElement('canvas'); ghost.width=1; ghost.height=1; e.dataTransfer.setDragImage(ghost,0,0);
        e.dataTransfer.setData('application/json', JSON.stringify(p));
        e.dataTransfer.setData('text/pid', p.사번);
        e.dataTransfer.setData('text/from','list');
      });
      peopleBox.appendChild(card);
    });
  }
  // 오른쪽으로 드롭 = 배정 취소
  peopleBox.addEventListener('dragover', e=>{ e.preventDefault(); peopleBox.classList.add('drop-hover'); });
  peopleBox.addEventListener('dragleave', ()=> peopleBox.classList.remove('drop-hover'));
  peopleBox.addEventListener('drop', e=>{
    e.preventDefault(); peopleBox.classList.remove('drop-hover');
    const pid=e.dataTransfer.getData('text/pid'); const prev=e.dataTransfer.getData('text/roomId')||state.assigned.get(pid)||null;
    if(!pid||!prev) return;
    const os=ensureRoom(prev); os.occupants=os.occupants.filter(x=>x!==pid);
    state.assigned.delete(pid);
    renderRoom(prev); renderPeople();
    setStatus(`배정 취소: ${pid}`);
  });

  /* ========== 방 설정 패널 ========== */
  const panel=document.getElementById('roomPanel');
  const p_roomId=document.getElementById('p_roomId');
  const p_type=document.getElementById('p_type');
  const p_capacity=document.getElementById('p_capacity');
  const p_gender=document.getElementById('p_gender');
  document.getElementById('closePanel').onclick = ()=> panel.classList.remove('show');
  document.getElementById('applyPanel').onclick = ()=>{
    const id=p_roomId.value, st=ensureRoom(id);
    st.type=p_type.value;
    st.capacity=Math.max(1,parseInt(p_capacity.value||"1",10));
    st.gender=p_gender.value;
    renderRoomLabel(id);
    setStatus(`방 설정 적용: ${id}`);
  };
  document.getElementById('clearRoom').onclick = ()=>{
    const id=p_roomId.value, st=ensureRoom(id);
    st.occupants.forEach(pid=>state.assigned.delete(pid));
    st.occupants=[]; renderRoom(id); renderPeople();
    setStatus(`배정 전부 해제: ${id}`);
  };

  /* ========== 파일 로더 ========== */
  async function loadSvgFromFile(file){
    setStatus(`SVG: ${file.name} 로딩중`);
    const text=await file.text();
    const doc=new DOMParser().parseFromString(text,"image/svg+xml");
    let svg=doc.documentElement; if(svg.tagName.toLowerCase()!=='svg') svg=doc.querySelector('svg');
    if(!svg){ alert('유효한 SVG가 아닙니다'); setStatus('SVG 로드 실패'); return; }

    svgHost.querySelector('.placeholder')?.remove();
    svgLayer.innerHTML=""; overlay.innerHTML="";
    state.labels.clear(); state.dropzones.clear();

    svg.removeAttribute('width'); svg.removeAttribute('height'); if(!svg.getAttribute('viewBox')) svg.setAttribute('viewBox','0 0 1000 800');
    svgLayer.appendChild(svg); state.svgEl=svg;

    // 텍스트 기본색 보정
    svg.querySelectorAll('text').forEach(t=>{ if (!t.getAttribute('fill')) t.setAttribute('fill','#111827'); });

    // 드롭존 생성
    buildDropzones();
    // 라벨 생성
    [...svg.querySelectorAll('[id]')].forEach(n=>{ const id=(n.id||'').toLowerCase(); if(!id||id.startsWith('bg')) return; ensureRoom(n.id); renderRoomLabel(n.id); });

    setStatus('SVG 로드 완료');
  }

  async function loadAbbrExcel(file){
    const buf=await file.arrayBuffer();
    let wb; try{ wb=XLSX.read(new Uint8Array(buf),{type:'array'});}catch(e){ alert('약어 엑셀 파싱 실패'); return; }
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sheet,{defval:""});
    state.deptAbbr.clear();
    if(rows.length){
      const keys=Object.keys(rows[0]);
      const kDept = keys.find(k=>/진료과|부서|department|과/i.test(k)) || keys[0];
      const kAbbr = keys.find(k=>/약어|abbr|영문|코드/i.test(k)) || keys[1];
      rows.forEach(r=>{
        const full=(r[kDept]||"").toString().trim();
        const abbr=(r[kAbbr]||"").toString().trim();
        if(full && abbr) state.deptAbbr.set(full, abbr);
      });
    }
    renderPeople(); state.roomState.forEach((_, id)=> renderRoom(id));
    setStatus(`약어 ${state.deptAbbr.size}건 로드`);
  }

  async function loadExcelFromFile(file){
    setStatus(`교원 엑셀: ${file.name} 로딩중`);
    const buf=await file.arrayBuffer();
    let wb; try{ wb=XLSX.read(new Uint8Array(buf),{type:'array'}); }catch(e){ alert('엑셀 파싱 실패'); setStatus('엑셀 로드 실패'); return; }
    const name=wb.SheetNames.includes("기준변경 반영")?"기준변경 반영":wb.SheetNames[0];
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[name],{defval:""});
    const ppl=rows.map(r=>({
      사번:String(r["사번"]||""), 성명:r["성명"]||"", 부서:r["부서"]||r["진료과"]||"",
      직계:r["직계(직종)"]||"", 직위:r["직위"]||"", 성별:r["성별"]||"",
      승급일:r["승급일"]||"", 생년월일:r["생년월일"]||"", 호봉:r["호봉"]||""
    }))
    .filter(p=>!String(p.직계).startsWith("진료"))
    .filter(p=>Object.keys(TITLE_ORDER).includes(p.직위));

    state.people=ppl; state.assigned.clear(); state.roomState.forEach(st=>st.occupants=[]);
    // 드롭존/라벨은 유지, 칩만 초기화
    overlay.querySelectorAll('.occChip').forEach(el=>el.remove());

    // 진료과 필터
    const depts=[...new Set(ppl.map(p=>p.부서).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'ko'));
    deptFilter.innerHTML = '<option value="">전체 진료과</option>' + depts.map(d=>`<option value="${d}">${d}</option>`).join('');

    renderPeople();
    setStatus(`교원 ${ppl.length}명 로드 완료`);
  }

  // 이벤트 바인딩
  svgInput.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) loadSvgFromFile(f); });
  abbrInput.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) loadAbbrExcel(f); });
  xlInput  .addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) loadExcelFromFile(f); });
  resetBtn .addEventListener('click', ()=>{
    state.people=[]; state.assigned.clear(); state.roomState.clear(); state.labels.clear(); state.dropzones.clear(); state.deptAbbr.clear();
    peopleBox.innerHTML=""; svgLayer.innerHTML=""; overlay.innerHTML="";
    svgHost.querySelector('.placeholder')?.remove();
    const ph=document.createElement('div'); ph.className='placeholder'; ph.innerHTML='왼쪽의 <b>SVG</b>, <b>약어 엑셀</b>(선택), <b>교원 엑셀</b>을 업로드하세요';
    svgHost.prepend(ph);
    setStatus('초기화 완료');
  });

  // 필터/검색
  document.getElementById('search').addEventListener('input', e=>{ state.search=e.target.value||""; renderPeople(); });
  document.getElementById('deptFilter').addEventListener('change', e=>{ state.deptFilter=e.target.value||""; renderPeople(); });
  document.getElementById('genderFilter').addEventListener('change', e=>{ state.genderFilter=e.target.value||""; renderPeople(); });

  setStatus('대기 중… SVG/약어/교원 엑셀을 업로드하세요');
})();
</script>
</body>
</html>
